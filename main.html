<!doctype html public "-//w3c//dtd html 4.0 transitional//en"> 
<html> 
<head> 
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
	<title>Google Summer of Code Sandbox</title> 
	
	<!-- Sytlesheets -->
	<link rel="stylesheet" href="DefaultStyle.css" type="text/css" /> 
   <link rel="stylesheet" href="ExamplesStyle.css" type="text/css" /> 
	
	<!-- Libraries -->
	<script src="OpenLayers/lib/OpenLayers.js"></script> 

	<!-- Our code -->
	<script src="GeoRef.js"></script>
	<script src="myUtil.js"></script>
	<script type="text/javascript"> 


	function makeImageLayer(name, imageObject) {
		var w = imageObject.width;
		var h = imageObject.height;
		var bounds = new OpenLayers.Bounds(-180, -1*((180*h)/w), 180, ((180*h)/w));
		var size = new OpenLayers.Size(w, h);
		var opts = {
			numZoomLevels	: 10,
			maxResolution	: 1
		};
		return new OpenLayers.Layer.Image(name, imageObject.url, bounds, size, opts);
	}
	
	function makeMapFromImage(div, name, imageObject) {
		var map = new OpenLayers.Map(div);
		map.addLayer( makeImageLayer(name, imageObject) );
		map.zoomToMaxExtent();
		return map;
	}
	
	function addControlPointsLayer(mapObject, layerName) {
		var vl = new OpenLayers.Layer.Vector(layerName);
		mapObject.addLayer(vl);
		
		var count = (function() { 
			var i = 0; 
			return function() { 
				return ++i; 
			};
		})();
		
		// Increment the label each time a point is added
		vl.preFeatureInsert = function(feature) { 
			var string = "";
			feature.attributes = {
				label	: count()
			};
		}
		
		
		// Add styles to the vector layer (to display the label)
		var vs = new OpenLayers.Style({
			'label'			: '${label}',
			'fillColor'		: '#ee9900',
			'fillOpacity'	: .6,
			'strokeWidth'	: 2,
			'strokeColor'	: '#ee9900',
			'strokeOpacity': .7, 
			'pointRadius'	: 6,
			'labelXOffset'	: -10,
			'labelYOffset'	: -10
		});
		var vsm = new OpenLayers.StyleMap({
			'default'		: vs
		});
		
		vl.styleMap = vsm;
		
		// Add the DrawPoints Control
		var control = new OpenLayers.Control.DrawFeature(vl, OpenLayers.Handler.Point);
		mapObject.addControl(control);
		control.activate();

		
		return vl;
	}
	
	function collectPoints(vectorLayer, $pointArray, outputName, imageObject) {
		// Register for featureadded events
		vectorLayer.events.register('featureadded', this, function(event) { 
			// Add Points to the array
			var p = new GeoRef.Point(event.feature.geometry.x, event.feature.geometry.y, imageObject);
			$pointArray[$pointArray.length] = p;
			// Temporarily display the points
			var string = "";
			for(var i = 0; i < $pointArray.length; ++i) {
				string = string + "<p>Point #"+(i+1)+"	x: "+$pointArray[i].x+"	y: "+$pointArray[i].y +"</p>";
			}
			document.getElementById(outputName).innerHTML = string; 
		});
	}
	
	function calculateWorldFile(subPointsArray, basePointsArray, $worldFile) {
		var s = subPointsArray;
		var b = basePointsArray;
		var w = $worldFile;
		var length = s.length > b.length ? s.length : b.length;
		
		// calculate translation
		var sPoint = s[0];
		var bPoint = b[0];
		
		console.log(sPoint.x);
	
		
		for(var i = 1; i < length; ++i) {
			
		}
	}
	function init() {
		var baseImage = new GeoRef.Image(
			"base.png",
			2000,
			1000
		);
		var subImage = new GeoRef.Image(
			"sub.png",
			2000,
			1000
		);
		
		
		var subLayer = makeImageLayer("sub image", subImage);
		var baseLayer = makeImageLayer("base image", baseImage);
		
		var base = new OpenLayers.Map("base");
		base.addLayer(baseLayer);
		base.zoomToMaxExtent();
		
		var sub = new OpenLayers.Map("sub");
		sub.addLayer(subLayer);
		sub.zoomToMaxExtent();

		base.addControl( new OpenLayers.Control.MousePosition());

		/*
		 * Add vector layers for making control points.
		 */
		var baseCPLayer = addControlPointsLayer(base, "base points layer");
		var subCPLayer = addControlPointsLayer(sub, "sub points layer");	
		
		var baseCPs = new Array();
		var subCPs = new Array();
		collectPoints(baseCPLayer, baseCPs, "basePoints", baseImage);
		collectPoints(subCPLayer, subCPs, "subPoints", subImage);
		
		
		
		var worldFile = {
			A			: 100,
			B			: 0, // only this works
			C			: 0, // and this works
			D			: -100,
			E			: 0,
			F			: 0
		};
		
		myUtil.POST("alterImage.php", worldFile, function(response){
			document.getElementById("text").innerHTML = response;
			
			// now that we've altered the sub image...
			var sub2Image = new GeoRef.Image(
				"alteredSub.png",
				2000,
				1000
			);		
			// make the altered image into a layer
			var sub2Layer = makeImageLayer("sub altered", sub2Image);
			sub2Layer.setIsBaseLayer(false);
			
			// add the altered image to the base image
			base.addLayer(sub2Layer);
			base.addControl(new OpenLayers.Control.LayerSwitcher());
		
		} );
	 		
	}
	
 	</script> 
</head> 
<body onload="init()"> 
<h1>Google Summer of Code Sandbox</h1>
<div id="text"></div>
<div id="base" class="smallmap"></div>
<div id="sub" class="smallmap"></div>
<h3>Base Image Control Points</h3>
<div id="basePoints"></div>
<br>
<h3>Sub Image Control Points</h3>
<div id="subPoints"></div>
</body>
</head>